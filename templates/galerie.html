<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galerie Anime - Okatech</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gallery.css') }}">
    <script src="{{ url_for('static', filename='js/script3.js') }}" defer></script>
</head>

<body>
    <header>
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Logo Okatech" id="logo" />
        </div>
        <div class="site-title">PixelVerse</div>
        <nav>
            <div class="menu-icon" id="burger">&#9776;</div>
            <ul class="nav-links" id="navLinks">
                <div class="menu-icon" id="closeSidebar">&times;</div>
                <li><a href="/" class="g">ğŸ  Accueil</a></li>
                <li><a href="/galerie" class="o">ğŸŒ Galerie Anime</a></li>
                <li><a href="/populaires">ğŸ”¥ Populaires</a></li>
                {% if session.get('user_id') %}
                <li><a href="/favoris" class="o">â­ Mes Favoris</a></li>
                <li><a href="/profil" class="o">ğŸ’¡ Mon Profil</a></li>
                <li><a href="/deconnexion" class="o">ğŸšª DÃ©connexion</a></li>
                {% else %}
                <li><a href="/formulaire" class="o">ğŸ’¡ Inscription</a></li>
                <li><a href="/connexion" class="o">ğŸ”’ Connexion</a></li>
                {% endif %}
                {% if session.get('role') == 'admin' %}
                <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li><a href="{{ url_for('stats') }}">Statistiques</a></li>
                {% endif %}
            </ul>
        </nav>
    </header>


    <main>
        <nav class="dropdown-menu">
            <button class="dropbtn">CatÃ©gories â–¼</button>
            <div class="dropdown-content">
                <a href="personnage.html">ğŸ Personnage</a>
                <a href="paysage.html">ğŸŒ„ Paysage</a>
                <a href="mecha.html">ğŸ¤– Mecha</a>
                <a href="animal.html">ğŸ¾ Animal</a>
                <a href="autre.html">âœ¨ Autre</a>
            </div>
        </nav>

        <section class="gallery" id="gallery">
            {% for image in images %}
            <div class="gallery-item" style="display:none;">
                <img src="{{ url_for('static', filename='images/' + image) }}" alt="{{ image }}" loading="lazy"
                    onclick="openLightbox('{{ url_for('static', filename='images/' + image) }}')">
                <div class="like-section">
                    <a href="{{ url_for('static', filename='images/' + image) }}" download class="download-btn"
                        title="TÃ©lÃ©charger l'image">
                        â¬‡ï¸
                    </a>
                    {% set liked = image in liked_images %}
                    <button aria-label="Like" class="like-btn{% if liked %} liked{% endif %}" data-image="{{ image }}"
                        data-liked="{{ '1' if liked else '0' }}">
                        <span class="like-icon">{% if liked %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                    </button>
                    <span class="like-count" id="like-count-{{ image }}">{{ likes[image] }}</span>
                </div>
            </div>
            {% endfor %}
        </section>
        <div id="loader" class="loader" style="display:none;"></div>
        <!-- Lightbox/Modale pour l'aperÃ§u en grand -->
        <div id="lightbox" class="lightbox" style="display:none;">
            <span class="close" id="closeLightbox">&times;</span>
            <img class="lightbox-content" id="lightbox-img" src="" alt="AperÃ§u en grand">
        </div>


    </main>

    <footer>
        <p>&copy; 2025 PixelVerse. Tous droits rÃ©servÃ©s.</p>
    </footer>

    <script>
        function openLightbox(src) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            lightboxImg.src = src;
            lightbox.style.display = 'flex';
        }
        document.getElementById('closeLightbox').onclick = function () {
            document.getElementById('lightbox').style.display = 'none';
            document.getElementById('lightbox-img').src = '';
        };
        // Fermer la lightbox en cliquant en dehors de l'image
        document.getElementById('lightbox').onclick = function (e) {
            if (e.target === this) {
                this.style.display = 'none';
                document.getElementById('lightbox-img').src = '';
            }
        };

        // Infinite scroll
        const galleryItems = Array.from(document.querySelectorAll('.gallery-item'));
        const loader = document.getElementById('loader');
        let itemsPerLoad = 10;
        let itemsToShow = 20;
        let currentIndex = 0;

        function showNextImages() {
            loader.style.display = 'block';
            setTimeout(() => {
                let count = 0;
                while (currentIndex < galleryItems.length && count < itemsPerLoad) {
                    const item = galleryItems[currentIndex];
                    item.style.display = 'block';
                    item.classList.add('fade-in');
                    currentIndex++;
                    count++;
                }
                loader.style.display = 'none';
            }, 400); // Simule un petit dÃ©lai de chargement
        }

        // Affiche les premiÃ¨res images
        window.addEventListener('DOMContentLoaded', () => {
            let count = 0;
            while (currentIndex < galleryItems.length && count < itemsToShow) {
                const item = galleryItems[currentIndex];
                item.style.display = 'block';
                item.classList.add('fade-in');
                currentIndex++;
                count++;
            }
        });

        // DÃ©tecte le scroll bas de page
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 200)) {
                if (currentIndex < galleryItems.length && loader.style.display === 'none') {
                    showNextImages();
                }
            }
        });

        // Like/Unlike dynamique
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                const image = this.getAttribute('data-image');
                const liked = this.getAttribute('data-liked') === '1';
                const action = liked ? 'unlike' : 'like';
                fetch('/like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_name: image, action: action })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            this.setAttribute('data-liked', liked ? '0' : '1');
                            this.classList.toggle('liked', !liked);
                            this.querySelector('.like-icon').textContent = liked ? 'ğŸ¤' : 'â¤ï¸';
                            document.getElementById('like-count-' + image).textContent = data.like_count;
                        } else {
                            alert(data.message || 'Erreur lors du like.');
                        }
                    })
                    .catch(() => alert('Connecter vous pour liker.'));
            });
        });
    </script>
</body>

</html>